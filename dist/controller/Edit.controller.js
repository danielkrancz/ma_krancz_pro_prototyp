sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/m/MessageBox","sap/ui/export/Spreadsheet","sap/ui/export/library","sap/m/p13n/Engine","sap/m/p13n/SelectionController","sap/m/p13n/SortController","sap/m/p13n/GroupController","sap/m/p13n/MetadataHelper","sap/m/table/ColumnWidthController","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ui/core/library","sap/ui/table/Column","sap/m/Column","sap/m/Label","sap/ui/core/Fragment"],(e,t,n,a,i,o,r,l,s,d,u,g,p,h,c,m,w,C)=>{"use strict";var f=i.EdmType;return e.extend("at.hb.makrancz.procodeapp.controller.Edit",{onInit:function(){this.getOwnerComponent().getRouter().getRoute("Edit").attachPatternMatched(this.onPatternMatched,this)},onPatternMatched:function(e){this.sTravelID=e.getParameters().arguments.TravelID;this.path=`/Travel('${this.sTravelID}')`;this.getOwnerComponent().getModel().read(this.path,{urlParameters:{$expand:"to_Booking"},success:e=>{this.editModel=new g(e);this.getView().setModel(this.editModel,"editModel");this.getView().bindElement({path:"/",model:"editModel"})}});this.uiModel=new g({supportMultiselect:false,supportRanges:false});this.getView().setModel(this.uiModel,"ui")},onSave:function(){let e=this.getView().getModel("editModel").getData(),t=[];t.push(new Promise((t,n)=>{this.getView().getModel().update(this.path,{AgencyID:e.AgencyID,CustomerID:e.CustomerID,BeginDate:new Date(e.BeginDate),EndDate:new Date(e.EndDate),BookingFee:e.BookingFee,CurrencyCode:e.CurrencyCode,OverallStatus:e.OverallStatus,Description:e.Description},{success:()=>{t()}})}));e.to_Booking.results.forEach(e=>{t.push(new Promise((t,n)=>{this.getView().getModel().update(`/Booking(TravelID='${e.TravelID}',BookingID='${e.BookingID}')`,{CarrierID:e.CarrierID,ConnectionID:e.ConnectionID,FlightDate:new Date(e.FlightDate),FlightPrice:e.FlightPrice,CurrencyCode:e.CurrencyCode,BookingStatus:e.BookingStatus},{success:()=>{t()}})}))});Promise.allSettled(t).then(()=>{p.show("Successfully saved.");this.getView().getModel().refresh();this.getOwnerComponent().getRouter().navTo("Detail",{TravelID:this.sTravelID})})},onNavBack(){const e=t.getInstance();const n=e.getPreviousHash();if(n!==undefined){window.history.go(-1)}else{const e=this.getOwnerComponent().getRouter();e.navTo("RouteMain",{},true)}},onCancel:function(){n.warning("Your entries will be lost when you leave this page.",{actions:["Leave Page","Cancel"],emphasizedAction:"Leave Page",initialFocus:"Cancel",onClose:e=>{if(e==="Leave Page"){this.onNavBack()}}})},onExport:function(){var e,t,n,i,o;if(!this.oTable){this.oTable=this.byId("bookingTable")}o=this.oTable;t=o.getBinding("items");e=this.createColumnConfig();n={workbook:{columns:e,hierarchyLevel:"Level"},dataSource:t,fileName:"Bookings.xlsx",worker:false};i=new a(n);i.build().finally(function(){i.destroy()})},createColumnConfig:function(){var e=[];e.push({label:"Booking Number",property:"BookingID",type:f.String});e.push({label:"Booking Date",property:"BookingDate",type:f.Date});e.push({label:"Customer ID",property:["CustomerID","CustomerName"],type:f.String,template:"{1} ({0})"});e.push({label:"Airline ID",property:["CarrierID","CarrierName"],type:f.String,template:"{1} ({0})"});e.push({label:"Flight",property:"ConnectionID",type:f.String});e.push({label:"Flight Date",property:"FlightDate",type:f.Date});e.push({label:"Flight Price",type:f.Number,property:"FlightPrice",scale:2});e.push({label:"Booking Status",property:"BookingStatusText",type:f.String});return e},_registerForP13n:function(){var e=this.byId("bookingTable");this.oMetadataHelper=new d([{key:"bookingid",label:"Booking Number",path:"BookingID",cell:"{TravelID}"},{key:"bookingdate",label:"Booking Date",path:"BookingDate",cell:"{path: 'BookingDate', type: 'sap.ui.model.odata.type.Date'}"},{key:"customerid",label:"Customer ID",path:"CustomerID",cell:"{CustomerName} ({CustomerID})"},{key:"carrierid",label:"Airline ID",path:"CarrierID",cell:"{CarrierName} ({CarrierID})"},{key:"connectionid",label:"Flight",path:"ConnectionID",cell:"{ConnectionID}"},{key:"flightdate",label:"Flight Date",path:"FlightDate",cell:"{ path: 'FlightDate', type: 'sap.ui.model.odata.type.Date' }"},{key:"flightprice",label:"Flight Price",path:"FlightPrice"},{key:"status",label:"Booking Status",path:"BookingStatusText",cell:"{BookingStatusText}"}]);o.getInstance().register(e,{helper:this.oMetadataHelper,controller:{Columns:new r({targetAggregation:"columns",control:e}),Sorter:new l({control:e}),Groups:new s({control:e}),ColumnWidth:new u({control:e})}});o.getInstance().attachStateChange(this.handleStateChange.bind(this))},openPersoDialog:function(e){var t=this.byId("bookingTable");o.getInstance().show(t,["Columns","Sorter","Groups"],{contentHeight:"35rem",contentWidth:"32rem",source:e.getSource()})},_getKey:function(e){return this.getView().getLocalId(e.getId())},handleStateChange:function(e){var t=this.byId("bookingTable");var n=e.getParameter("state");if(!n){return}var a=[];n.Groups.forEach(function(e){a.push(new Sorter(this.oMetadataHelper.getProperty(e.key).path,false,true))}.bind(this));n.Sorter.forEach(function(e){var t=a.find(function(t){return t.sPath===this.oMetadataHelper.getProperty(e.key).path}.bind(this));if(t){t.bDescending=!!e.descending}else{a.push(new Sorter(this.oMetadataHelper.getProperty(e.key).path,e.descending))}}.bind(this));t.getColumns().forEach(function(e,t){e.setVisible(false);e.setWidth(n.ColumnWidth[this._getKey(e)]);e.setSortIndicator(h.SortOrder.None);e.data("grouped",false)}.bind(this));n.Sorter.forEach(function(e){var t=this.byId(e.key);if(e.sorted!==false){t.setSortIndicator(e.descending?h.SortOrder.Descending:h.SortOrder.Ascending)}}.bind(this));n.Groups.forEach(function(e){var t=this.byId(e.key);t.data("grouped",true)}.bind(this));n.Columns.forEach(function(e,n){var a=this.byId(e.key);a.setVisible(true);t.removeColumn(a);t.insertColumn(a,n)}.bind(this));var i=n.Columns.map(function(e){return new Text({text:this.oMetadataHelper.getProperty(e.key).cell})}.bind(this));t.bindItems({templateShareable:false,path:"to_Booking",sorter:a,template:new ColumnListItem({cells:i})})},beforeOpenColumnMenu:function(e){var t=this.byId("menu");var n=e.getParameter("openBy");var a=t.getQuickActions()[0].getItems()[0];var i=t.getQuickActions()[1].getItems()[0];a.setKey(this._getKey(n));a.setLabel(n.getHeader().getText());a.setSortOrder(n.getSortIndicator());i.setKey(this._getKey(n));i.setLabel(n.getHeader().getText());i.setGrouped(n.data("grouped"))},onColumnHeaderItemPress:function(e){var t=this.byId("bookingTable");var n=e.getSource();var a="Columns";if(n.getIcon().indexOf("group")>=0){a="Groups"}else if(n.getIcon().indexOf("sort")>=0){a="Sorter"}o.getInstance().show(t,[a],{contentHeight:"35rem",contentWidth:"32rem",source:t})},onSort:function(e){var t=e.getParameter("item");var n=this.byId("bookingTable");var a=t.getKey();var i=t.getSortOrder();o.getInstance().retrieveState(n).then(function(e){e.Sorter.forEach(function(e){e.sorted=false});if(i!==h.SortOrder.None){e.Sorter.push({key:a,descending:i===h.SortOrder.Descending})}o.getInstance().applyState(n,e)})},onGroup:function(e){var t=e.getParameter("item");var n=this.byId("bookingTable");var a=t.getKey();o.getInstance().retrieveState(n).then(function(e){e.Groups.forEach(function(e){e.grouped=false});if(t.getGrouped()){e.Groups.push({key:a})}o.getInstance().applyState(n,e)})},onColumnMove:function(e){var t=e.getParameter("draggedControl");var n=e.getParameter("droppedControl");if(t===n){return}var a=this.byId("bookingTable");var i=e.getParameter("dropPosition");var r=a.indexOfColumn(t);var l=a.indexOfColumn(n);var s=l+(i=="Before"?0:1)+(r<l?-1:0);var d=this._getKey(t);o.getInstance().retrieveState(a).then(function(e){var t=e.Columns.find(function(e){return e.key===d})||{key:d};t.position=s;o.getInstance().applyState(a,{Columns:[t]})})},onColumnResize:function(e){var t=e.getParameter("column");var n=e.getParameter("width");var a=this.byId("bookingTable");var i={};i[this._getKey(t)]=n;o.getInstance().applyState(a,{ColumnWidth:i})},onAgencyValueHelpRequested:function(e){this._oInput=e.getSource();this.sVHPath="/AgencyID";C.load({name:"at.hb.makrancz.procodeapp.view.fragment.ValueHelpDialogAgency",controller:this}).then(function(e){var t=e.getFilterBar();this._oVHD=e;this.getView().addDependent(e);e.setRangeKeyFields([{label:"Agency",key:"AgencyID",type:"string"}]);t.setFilterBarExpanded(false);e.getTableAsync().then(function(t){if(t.bindRows){t.bindAggregation("rows",{path:"/TravelAgency",events:{dataReceived:function(){e.update()}}});let n=new c({label:new w({text:"Agency ID"}),template:new Text({wrapping:false,text:"{AgencyID}"})});n.data({fieldName:"AgencyID"});let a=new c({label:new w({text:"Agency Name"}),template:new Text({wrapping:false,text:"{AgencyName}"})});a.data({fieldName:"AgencyName"});let i=new c({label:new w({text:"Street"}),template:new Text({wrapping:false,text:"{Street}"})});i.data({fieldName:"Street"});let o=new c({label:new w({text:"Postal Code"}),template:new Text({wrapping:false,text:"{PostalCode}"})});o.data({fieldName:"PostalCode"});let r=new c({label:new w({text:"City"}),template:new Text({wrapping:false,text:"{City}"})});r.data({fieldName:"City"});let l=new c({label:new w({text:"Country Code"}),template:new Text({wrapping:false,text:"{CountryCode}"})});l.data({fieldName:"CountryCode"});let s=new c({label:new w({text:"Phone"}),template:new Text({wrapping:false,text:"{PhoneNumber}"})});s.data({fieldName:"PhoneNumber"});let d=new c({label:new w({text:"Email"}),template:new Text({wrapping:false,text:"{EMailAddress}"})});d.data({fieldName:"EMailAddress"});let u=new c({label:new w({text:"Website"}),template:new Text({wrapping:false,text:"{WebAddress}"})});u.data({fieldName:"WebAddress"});t.addColumn(n);t.addColumn(a);t.addColumn(i);t.addColumn(o);t.addColumn(l);t.addColumn(s);t.addColumn(d);t.addColumn(u)}if(t.bindItems){t.bindAggregation("items",{path:"/TravelAgency",template:new ColumnListItem({cells:[new w({text:"{AgencyID}"}),new w({text:"{AgencyName}"}),new w({text:"{Street}"}),new w({text:"{PostalCode}"}),new w({text:"{City}"}),new w({text:"{CountryCode}"}),new w({text:"{PhoneNumber}"}),new w({text:"{EMailAddress}"}),new w({text:"{WebAddress}"})]}),events:{dataReceived:function(){e.update()}}});t.addColumn(new m({header:new w({text:"Agency ID"})}));t.addColumn(new m({header:new w({text:"Agency Name"})}));t.addColumn(new m({header:new w({text:"Steet"})}));t.addColumn(new m({header:new w({text:"Postal Code"})}));t.addColumn(new m({header:new w({text:"City"})}));t.addColumn(new m({header:new w({text:"Country"})}));t.addColumn(new m({header:new w({text:"Phone"})}));t.addColumn(new m({header:new w({text:"Email"})}));t.addColumn(new m({header:new w({text:"Website"})}))}e.update()}.bind(this));e.open()}.bind(this))},onCustomerValueHelpRequested:function(e){this._oInput=e.getSource();this.sVHPath="/CustomerID";C.load({name:"at.hb.makrancz.procodeapp.view.fragment.ValueHelpDialogCustomer",controller:this}).then(function(e){var t=e.getFilterBar();this._oVHD=e;this.getView().addDependent(e);e.setRangeKeyFields([{label:"Customer",key:"CustomerID",type:"string"}]);t.setFilterBarExpanded(false);e.getTableAsync().then(function(t){if(t.bindRows){t.bindAggregation("rows",{path:"/Passenger",events:{dataReceived:function(){e.update()}}});let n=new c({label:new w({text:"Customer ID"}),template:new Text({wrapping:false,text:"{CustomerID}"})});n.data({fieldName:"CustomerID"});let a=new c({label:new w({text:"First Name"}),template:new Text({wrapping:false,text:"{FirstName}"})});a.data({fieldName:"FirstName"});let i=new c({label:new w({text:"Last Name"}),template:new Text({wrapping:false,text:"{LastName}"})});i.data({fieldName:"LastName"});let o=new c({label:new w({text:"Title"}),template:new Text({wrapping:false,text:"{Title}"})});o.data({fieldName:"Title"});let r=new c({label:new w({text:"Street"}),template:new Text({wrapping:false,text:"{Street}"})});r.data({fieldName:"Street"});t.addColumn(n);t.addColumn(a);t.addColumn(i);t.addColumn(o);t.addColumn(r)}if(t.bindItems){t.bindAggregation("items",{path:"/Passenger",template:new ColumnListItem({cells:[new w({text:"{CustomerID}"}),new w({text:"{FirstName}"}),new w({text:"{LastName}"}),new w({text:"{Title}"}),new w({text:"{Street}"})]}),events:{dataReceived:function(){e.update()}}});t.addColumn(new m({header:new w({text:"Customer ID"})}));t.addColumn(new m({header:new w({text:"First Name"})}));t.addColumn(new m({header:new w({text:"Last Name"})}));t.addColumn(new m({header:new w({text:"Title"})}));t.addColumn(new m({header:new w({text:"Steet"})}))}e.update()}.bind(this));e.open()}.bind(this))},onCurrencyValueHelpRequested:function(e){this._oInput=e.getSource();debugger;this.sVHPath=e.getSource().getBindingContext("editModel").getPath()+"CurrencyCode";C.load({name:"at.hb.makrancz.procodeapp.view.fragment.ValueHelpDialogCurrency",controller:this}).then(function(e){var t=e.getFilterBar();this._oVHD=e;this.getView().addDependent(e);e.setRangeKeyFields([{label:"Currency Code",key:"CurrencyCode",type:"string"}]);t.setFilterBarExpanded(false);e.getTableAsync().then(function(t){if(t.bindRows){t.bindAggregation("rows",{path:"/Currency",events:{dataReceived:function(){e.update()}}});let n=new c({label:new w({text:"Currency"}),template:new Text({wrapping:false,text:"{Currency}"})});n.data({fieldName:"Currency"});let a=new c({label:new w({text:"Description"}),template:new Text({wrapping:false,text:"{Currency_Text}"})});a.data({fieldName:"Currency_Text"});t.addColumn(n);t.addColumn(a)}if(t.bindItems){t.bindAggregation("items",{path:"/Currency",template:new ColumnListItem({cells:[new w({text:"{Currency}"}),new w({text:"{Currency_Text}"})]}),events:{dataReceived:function(){e.update()}}});t.addColumn(new m({header:new w({text:"Currency"})}));t.addColumn(new m({header:new w({text:"Description"})}))}e.update()}.bind(this));e.open()}.bind(this))},onFlightValueHelpRequested:function(e){this.bFlightVH=true;this.sBookingPath=e.getSource().getBindingContext("editModel").getPath();C.load({name:"at.hb.makrancz.procodeapp.view.fragment.ValueHelpDialogFlight",controller:this}).then(function(e){var t=e.getFilterBar();this._oVHD=e;this.getView().addDependent(e);t.setFilterBarExpanded(false);e.getTableAsync().then(function(t){if(t.bindRows){t.bindAggregation("rows",{path:"/Flight",events:{dataReceived:function(){e.update()}}});let n=new c({label:new w({text:"Airline ID"}),template:new Text({wrapping:false,text:"{AirlineID}"})});n.data({fieldName:"AirlineID"});let a=new c({label:new w({text:"Flight Number"}),template:new Text({wrapping:false,text:"{ConnectionID}"})});a.data({fieldName:"ConnectionID"});let i=new c({label:new w({text:"Flight Date"}),template:new Text({wrapping:false,text:"{FlightDate}"})});i.data({fieldName:"FlightDate"});let o=new c({label:new w({text:"Flight Price"}),template:new Text({wrapping:false,text:"{Price}"})});o.data({fieldName:"Price"});let r=new c({label:new w({text:"Plane Type"}),template:new Text({wrapping:false,text:"{PlaneType}"})});r.data({fieldName:"PlaneType"});let l=new c({label:new w({text:"Maximum Seats"}),template:new Text({wrapping:false,text:"{MaximumSeats}"})});l.data({fieldName:"MaximumSeats"});let s=new c({label:new w({text:"Occupied Seats"}),template:new Text({wrapping:false,text:"{Occupied Seats}"})});s.data({fieldName:"OccupiedSeats"});t.addColumn(n);t.addColumn(a);t.addColumn(i);t.addColumn(o);t.addColumn(r);t.addColumn(l);t.addColumn(s)}if(t.bindItems){t.bindAggregation("items",{path:"/Flight",template:new ColumnListItem({cells:[new w({text:"{AirlineID}"}),new w({text:"{ConnectionID}"}),new w({text:"{FlightDate}"}),new w({text:"{Price}"}),new w({text:"{PlaneType}"}),new w({text:"{MaximumSeats}"}),new w({text:"{OccupiedSeats}"})]}),events:{dataReceived:function(){e.update()}}});t.addColumn(new m({header:new w({text:"Airline ID"})}));t.addColumn(new m({header:new w({text:"Flight Number"})}));t.addColumn(new m({header:new w({text:"Flight Date"})}));t.addColumn(new m({header:new w({text:"Price"})}));t.addColumn(new m({header:new w({text:"Plane Type"})}));t.addColumn(new m({header:new w({text:"Maximum Seats"})}));t.addColumn(new m({header:new w({text:"Occupied Seats"})}))}e.update()}.bind(this));e.open()}.bind(this))},onValueHelpOkPress:function(e){if(this.bFlightVH){e.getSource().getTableAsync().then(e=>{let t=e.getContextByIndex(e.getSelectedIndices()[0]).getObject();this.getView().getModel("editModel").setProperty(this.sBookingPath+"/CarrierID",t.AirlineID);this.getView().getModel("editModel").setProperty(this.sBookingPath+"/ConnectionID",t.ConnectionID);this.getView().getModel("editModel").setProperty(this.sBookingPath+"/FlightDate",t.FlightDate);this.getView().getModel("editModel").setProperty(this.sBookingPath+"/FlightPrice",t.Price);this.getView().getModel("editModel").setProperty(this.sBookingPath+"/CurrencyCode",t.CurrencyCode)})}else{this.getView().getModel("editModel").setProperty(this.sVHPath,e.getParameters().tokens[0].getKey())}this._oVHD.close()},onValueHelpCancelPress:function(){this._oVHD.close()},onValueHelpAfterClose:function(){this._oVHD.destroy()}})});
//# sourceMappingURL=Edit.controller.js.map