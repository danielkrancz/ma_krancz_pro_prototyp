sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/p13n/Engine","sap/m/p13n/SelectionController","sap/m/p13n/SortController","sap/m/p13n/GroupController","sap/m/p13n/MetadataHelper","sap/m/table/ColumnWidthController","sap/ui/core/library","sap/ui/export/library","sap/ui/export/Spreadsheet","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/Sorter","sap/m/ColumnListItem","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/comp/smartvariants/PersonalizableInfo","sap/m/Token","sap/ui/core/Fragment","sap/ui/model/type/String","sap/ui/table/Column","sap/m/Column","sap/m/Label"],(e,t,a,n,r,i,l,o,s,d,u,p,g,h,c,m,f,y,b,w,v,C,x,I)=>{"use strict";var S=s.EdmType;return e.extend("at.hb.makrancz.procodeapp.controller.Main",{onInit(){this._uiModel=new u({usePopin:false,itemSelected:false});this.getView().setModel(this._uiModel,"ui");this._registerForP13n();this.applyData=this.applyData.bind(this);this.fetchData=this.fetchData.bind(this);this.getFiltersWithValues=this.getFiltersWithValues.bind(this);this.oSmartVariantManagement=this.getView().byId("svm");this.oExpandedLabel=this.getView().byId("expandedLabel");this.oSnappedLabel=this.getView().byId("snappedLabel");this.oFilterBar=this.getView().byId("filterbar");this.oTable=this.byId("travelTable");this.oFilterBar.registerFetchData(this.fetchData);this.oFilterBar.registerApplyData(this.applyData);this.oFilterBar.registerGetFiltersWithValues(this.getFiltersWithValues);var e=new y({type:"filterBar",keyName:"persistencyKey",dataSource:"",control:this.oFilterBar});this.oSmartVariantManagement.addPersonalizableControl(e);this.oSmartVariantManagement.initialise(function(){},this.oFilterBar);var t=function(e){var t=e.text;return new b({key:t,text:t})};this.getView().byId("inputCustomerFilter").addValidator(t);this.getView().byId("inputAgencyFilter").addValidator(t)},onPopinSelectionChanged:function(e){let t=e.getSource().getSelectedKey();this._uiModel.setProperty("/usePopin",t==="X"?true:false)},onTableSelectionChanged:function(e){this._uiModel.setProperty("/itemSelected",true)},onListItemPressed:function(e){let t=e.getSource().getBindingContext().getObject().TravelID;this.getOwnerComponent().getRouter().navTo("Detail",{TravelID:t},false)},onCreatePressed:function(){this.getOwnerComponent().getRouter().navTo("Detail",{TravelID:"-"},true)},onCopyPressed:function(){let e=this.getView().byId("travelTable").getSelectedItem().getBindingContext();this.getView().getModel().callFunction("/copyTravel",{urlParameters:{TravelID:e.getObject().TravelID},method:"POST",success:e=>{debugger;this.getOwnerComponent().getRouter().navTo("Detail",{TravelID:e.TravelID},false)}})},onDeleteItem:function(){let e=this.getView().byId("travelTable").getSelectedItem().getBindingContext();p.confirm("Delete object "+e.getObject().TravelID,{actions:["Delete","Cancel"],emphasizedAction:"Delete",initialFocus:"Cancel",onClose:t=>{if(t==="Delete"){this.getView().setBusy(true);this.getView().getModel().remove(e.getPath(),{success:()=>{this.getView().setBusy(false);this.getView().byId("travelTable").getBinding("items").refresh();g.show("Object was deleted.")},error:()=>{this.getView().setBusy(false)}})}}})},fetchData:function(){var e=this.oFilterBar.getAllFilterItems().reduce(function(e,t){e.push({groupName:t.getGroupName(),fieldName:t.getName(),fieldData:t.getControl().getSelectedKeys()});return e},[]);return e},applyData:function(e){e.forEach(function(e){var t=this.oFilterBar.determineControlByName(e.fieldName,e.groupName);t.setSelectedKeys(e.fieldData)},this)},getFiltersWithValues:function(){var e=this.oFilterBar.getFilterGroupItems().reduce(function(e,t){var a=t.getControl();if(a&&a.getSelectedKeys&&a.getSelectedKeys().length>0){e.push(t)}return e},[]);return e},onSelectionChange:function(e){this.oSmartVariantManagement.currentVariantSetModified(true);this.oFilterBar.fireFilterChange(e)},onSearch:function(){var e=this.oFilterBar.getFilterGroupItems().reduce(function(e,t){var a=t.getControl(),n=[],r=[];if(a.getId().includes("OverallStatus")){n=a.getSelectedKeys()}else{a.getTokens().forEach(e=>{n.push(e.getKey())})}r=n.map(function(e){return new m({path:t.getName(),operator:f.Contains,value1:e})});if(n.length>0){e.push(new m({filters:r,and:false}))}return e},[]);this.oTable.getBinding("items").filter(e);this.oTable.setShowOverlay(false)},onFilterChange:function(){this._updateLabelsAndTable()},onAfterVariantLoad:function(){this._updateLabelsAndTable()},getFormattedSummaryText:function(){var e=this.oFilterBar.retrieveFiltersWithValues();if(e.length===0){return"No filters active"}if(e.length===1){return e.length+" filter active: "+e.join(", ")}return e.length+" filters active: "+e.join(", ")},getFormattedSummaryTextExpanded:function(){var e=this.oFilterBar.retrieveFiltersWithValues();if(e.length===0){return"No filters active"}var t=e.length+" filters active",a=this.oFilterBar.retrieveNonVisibleFiltersWithValues();if(e.length===1){t=e.length+" filter active"}if(a&&a.length>0){t+=" ("+a.length+" hidden)"}return t},_updateLabelsAndTable:function(){this.oExpandedLabel.setText(this.getFormattedSummaryTextExpanded());this.oSnappedLabel.setText(this.getFormattedSummaryText());this.oTable.setShowOverlay(true)},onAgencyValueHelpRequested:function(e){this._oMultiInput=e.getSource();w.load({name:"at.hb.makrancz.procodeapp.view.fragment.ValueHelpDialogAgency",controller:this}).then(function(e){var t=e.getFilterBar();this._oVHD=e;this.getView().addDependent(e);e.setRangeKeyFields([{label:"Agency",key:"AgencyID",type:"string"}]);t.setFilterBarExpanded(false);e.getTableAsync().then(function(t){if(t.bindRows){t.bindAggregation("rows",{path:"/TravelAgency",events:{dataReceived:function(){e.update()}}});let a=new C({label:new I({text:"Agency ID"}),template:new Text({wrapping:false,text:"{AgencyID}"})});a.data({fieldName:"AgencyID"});let n=new C({label:new I({text:"Agency Name"}),template:new Text({wrapping:false,text:"{AgencyName}"})});n.data({fieldName:"AgencyName"});let r=new C({label:new I({text:"Street"}),template:new Text({wrapping:false,text:"{Street}"})});r.data({fieldName:"Street"});let i=new C({label:new I({text:"Postal Code"}),template:new Text({wrapping:false,text:"{PostalCode}"})});i.data({fieldName:"PostalCode"});let l=new C({label:new I({text:"City"}),template:new Text({wrapping:false,text:"{City}"})});l.data({fieldName:"City"});let o=new C({label:new I({text:"Country Code"}),template:new Text({wrapping:false,text:"{CountryCode}"})});o.data({fieldName:"CountryCode"});let s=new C({label:new I({text:"Phone"}),template:new Text({wrapping:false,text:"{PhoneNumber}"})});s.data({fieldName:"PhoneNumber"});let d=new C({label:new I({text:"Email"}),template:new Text({wrapping:false,text:"{EMailAddress}"})});d.data({fieldName:"EMailAddress"});let u=new C({label:new I({text:"Website"}),template:new Text({wrapping:false,text:"{WebAddress}"})});u.data({fieldName:"WebAddress"});t.addColumn(a);t.addColumn(n);t.addColumn(r);t.addColumn(i);t.addColumn(o);t.addColumn(s);t.addColumn(d);t.addColumn(u)}if(t.bindItems){t.bindAggregation("items",{path:"/TravelAgency",template:new c({cells:[new I({text:"{AgencyID}"}),new I({text:"{AgencyName}"}),new I({text:"{Street}"}),new I({text:"{PostalCode}"}),new I({text:"{City}"}),new I({text:"{CountryCode}"}),new I({text:"{PhoneNumber}"}),new I({text:"{EMailAddress}"}),new I({text:"{WebAddress}"})]}),events:{dataReceived:function(){e.update()}}});t.addColumn(new x({header:new I({text:"Agency ID"})}));t.addColumn(new x({header:new I({text:"Agency Name"})}));t.addColumn(new x({header:new I({text:"Steet"})}));t.addColumn(new x({header:new I({text:"Postal Code"})}));t.addColumn(new x({header:new I({text:"City"})}));t.addColumn(new x({header:new I({text:"Country"})}));t.addColumn(new x({header:new I({text:"Phone"})}));t.addColumn(new x({header:new I({text:"Email"})}));t.addColumn(new x({header:new I({text:"Website"})}))}e.update()}.bind(this));e.setTokens(this._oMultiInput.getTokens());e.open()}.bind(this))},onCustomerValueHelpRequested:function(e){this._oMultiInput=e.getSource();w.load({name:"at.hb.makrancz.procodeapp.view.fragment.ValueHelpDialogCustomer",controller:this}).then(function(e){var t=e.getFilterBar();this._oVHD=e;this.getView().addDependent(e);e.setRangeKeyFields([{label:"Customer",key:"CustomerID",type:"string"}]);t.setFilterBarExpanded(false);e.getTableAsync().then(function(t){if(t.bindRows){t.bindAggregation("rows",{path:"/Passenger",events:{dataReceived:function(){e.update()}}});let a=new C({label:new I({text:"Customer ID"}),template:new Text({wrapping:false,text:"{CustomerID}"})});a.data({fieldName:"CustomerID"});let n=new C({label:new I({text:"First Name"}),template:new Text({wrapping:false,text:"{FirstName}"})});n.data({fieldName:"FirstName"});let r=new C({label:new I({text:"Last Name"}),template:new Text({wrapping:false,text:"{LastName}"})});r.data({fieldName:"LastName"});let i=new C({label:new I({text:"Title"}),template:new Text({wrapping:false,text:"{Title}"})});i.data({fieldName:"Title"});let l=new C({label:new I({text:"Street"}),template:new Text({wrapping:false,text:"{Street}"})});l.data({fieldName:"Street"});t.addColumn(a);t.addColumn(n);t.addColumn(r);t.addColumn(i);t.addColumn(l)}if(t.bindItems){t.bindAggregation("items",{path:"/Passenger",template:new c({cells:[new I({text:"{CustomerID}"}),new I({text:"{FirstName}"}),new I({text:"{LastName}"}),new I({text:"{Title}"}),new I({text:"{Street}"})]}),events:{dataReceived:function(){e.update()}}});t.addColumn(new x({header:new I({text:"Customer ID"})}));t.addColumn(new x({header:new I({text:"First Name"})}));t.addColumn(new x({header:new I({text:"Last Name"})}));t.addColumn(new x({header:new I({text:"Title"})}));t.addColumn(new x({header:new I({text:"Steet"})}))}e.update()}.bind(this));e.setTokens(this._oMultiInput.getTokens());e.open()}.bind(this))},onValueHelpOkPress:function(e){var t=e.getParameter("tokens");this._oMultiInput.setTokens(t);this._oVHD.close()},onValueHelpCancelPress:function(){this._oVHD.close()},onValueHelpAfterClose:function(){this._oVHD.destroy()},onExport:function(){var e,t,a,n,r;if(!this.oTable){this.oTable=this.byId("travelTable")}r=this.oTable;t=r.getBinding("items");e=this.createColumnConfig();a={workbook:{columns:e,hierarchyLevel:"Level"},dataSource:t,fileName:"Travels.xlsx",worker:false};n=new d(a);n.build().finally(function(){n.destroy()})},createColumnConfig:function(){var e=[];e.push({label:"Travel ID",property:"TravelID",type:S.String});e.push({label:"Agency ID",property:["AgencyID","AgencyName"],type:S.String,template:"{1} ({0})"});e.push({label:"Customer ID",property:["CustomerID","CustomerName"],type:S.String,template:"{1} ({0})"});e.push({label:"Starting Date",property:"BeginDate",type:S.Date});e.push({label:"End Date",property:"EndDate",type:S.Date});e.push({label:"Overall Status",property:"OverallStatusText",type:S.String});e.push({label:"Total Price",type:S.Number,property:"TotalPrice",scale:2});return e},_registerForP13n:function(){var e=this.byId("travelTable");this.oMetadataHelper=new i([{key:"travelid",label:"Travel ID",path:"TravelID",cell:"{TravelID}"},{key:"agencyid",label:"Agency ID",path:"AgencyID",cell:"{AgencyName} ({AgencyID})"},{key:"customerid",label:"Customer ID",path:"CustomerID",cell:"{CustomerName} ({CustomerID})"},{key:"begindate",label:"Starting Date",path:"BeginDate",cell:"{ path: 'BeginDate', type: 'sap.ui.model.odata.type.Date' }"},{key:"enddate",label:"End Date",path:"EndDate",cell:"{ path: 'EndDate', type: 'sap.ui.model.odata.type.Date' }"},{key:"status",label:"Overall Status",path:"OverallStatusText",cell:"{OverallStatusText}"},{key:"totalprice",label:"Total Price",path:"TotalPrice"}]);t.getInstance().register(e,{helper:this.oMetadataHelper,controller:{Columns:new a({targetAggregation:"columns",control:e}),Sorter:new n({control:e}),Groups:new r({control:e}),ColumnWidth:new l({control:e})}});t.getInstance().attachStateChange(this.handleStateChange.bind(this))},openPersoDialog:function(e){var a=this.byId("travelTable");t.getInstance().show(a,["Columns","Sorter","Groups"],{contentHeight:"35rem",contentWidth:"32rem",source:e.getSource()})},_getKey:function(e){return this.getView().getLocalId(e.getId())},handleStateChange:function(e){var t=this.byId("travelTable");var a=e.getParameter("state");if(!a){return}var n=[];a.Groups.forEach(function(e){n.push(new h(this.oMetadataHelper.getProperty(e.key).path,false,true))}.bind(this));a.Sorter.forEach(function(e){var t=n.find(function(t){return t.sPath===this.oMetadataHelper.getProperty(e.key).path}.bind(this));if(t){t.bDescending=!!e.descending}else{n.push(new h(this.oMetadataHelper.getProperty(e.key).path,e.descending))}}.bind(this));t.getColumns().forEach(function(e,t){e.setVisible(false);e.setWidth(a.ColumnWidth[this._getKey(e)]);e.setSortIndicator(o.SortOrder.None);e.data("grouped",false)}.bind(this));a.Sorter.forEach(function(e){var t=this.byId(e.key);if(e.sorted!==false){t.setSortIndicator(e.descending?o.SortOrder.Descending:o.SortOrder.Ascending)}}.bind(this));a.Groups.forEach(function(e){var t=this.byId(e.key);t.data("grouped",true)}.bind(this));a.Columns.forEach(function(e,a){var n=this.byId(e.key);n.setVisible(true);t.removeColumn(n);t.insertColumn(n,a)}.bind(this));var r=a.Columns.map(function(e){return new Text({text:this.oMetadataHelper.getProperty(e.key).cell})}.bind(this));t.bindItems({templateShareable:false,path:"/Travel",sorter:n,template:new c({type:"Navigation",press:this.onListItemPressed.bind(this),cells:r})})},beforeOpenColumnMenu:function(e){var t=this.byId("menu");var a=e.getParameter("openBy");var n=t.getQuickActions()[0].getItems()[0];var r=t.getQuickActions()[1].getItems()[0];n.setKey(this._getKey(a));n.setLabel(a.getHeader().getText());n.setSortOrder(a.getSortIndicator());r.setKey(this._getKey(a));r.setLabel(a.getHeader().getText());r.setGrouped(a.data("grouped"))},onColumnHeaderItemPress:function(e){var a=this.byId("travelTable");var n=e.getSource();var r="Columns";if(n.getIcon().indexOf("group")>=0){r="Groups"}else if(n.getIcon().indexOf("sort")>=0){r="Sorter"}t.getInstance().show(a,[r],{contentHeight:"35rem",contentWidth:"32rem",source:a})},onSort:function(e){var a=e.getParameter("item");var n=this.byId("travelTable");var r=a.getKey();var i=a.getSortOrder();t.getInstance().retrieveState(n).then(function(e){e.Sorter.forEach(function(e){e.sorted=false});if(i!==o.SortOrder.None){e.Sorter.push({key:r,descending:i===o.SortOrder.Descending})}t.getInstance().applyState(n,e)})},onGroup:function(e){var a=e.getParameter("item");var n=this.byId("travelTable");var r=a.getKey();t.getInstance().retrieveState(n).then(function(e){e.Groups.forEach(function(e){e.grouped=false});if(a.getGrouped()){e.Groups.push({key:r})}t.getInstance().applyState(n,e)})},onColumnMove:function(e){var a=e.getParameter("draggedControl");var n=e.getParameter("droppedControl");if(a===n){return}var r=this.byId("travelTable");var i=e.getParameter("dropPosition");var l=r.indexOfColumn(a);var o=r.indexOfColumn(n);var s=o+(i=="Before"?0:1)+(l<o?-1:0);var d=this._getKey(a);t.getInstance().retrieveState(r).then(function(e){var a=e.Columns.find(function(e){return e.key===d})||{key:d};a.position=s;t.getInstance().applyState(r,{Columns:[a]})})},onColumnResize:function(e){var a=e.getParameter("column");var n=e.getParameter("width");var r=this.byId("travelTable");var i={};i[this._getKey(a)]=n;t.getInstance().applyState(r,{ColumnWidth:i})}})});
//# sourceMappingURL=Main.controller.js.map